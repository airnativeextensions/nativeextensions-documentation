"use strict";(self.webpackChunknativeextensions_documentation=self.webpackChunknativeextensions_documentation||[]).push([[74184],{3905:(e,t,n)=>{n.d(t,{Zo:()=>p,kt:()=>m});var r=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?a(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function o(e,t){if(null==e)return{};var n,r,i=function(e,t){if(null==e)return{};var n,r,i={},a=Object.keys(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)n=a[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var l=r.createContext({}),u=function(e){var t=r.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=u(e.components);return r.createElement(l.Provider,{value:t},e.children)},c="mdxType",d={inlineCode:"code",wrapper:function(e){var t=e.children;return r.createElement(r.Fragment,{},t)}},f=r.forwardRef((function(e,t){var n=e.components,i=e.mdxType,a=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),c=u(n),f=i,m=c["".concat(l,".").concat(f)]||c[f]||d[f]||a;return n?r.createElement(m,s(s({ref:t},p),{},{components:n})):r.createElement(m,s({ref:t},p))}));function m(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var a=n.length,s=new Array(a);s[0]=f;var o={};for(var l in t)hasOwnProperty.call(t,l)&&(o[l]=t[l]);o.originalType=e,o[c]="string"==typeof e?e:i,s[1]=o;for(var u=2;u<a;u++)s[u]=n[u];return r.createElement.apply(null,s)}return r.createElement.apply(null,n)}f.displayName="MDXCreateElement"},85162:(e,t,n)=>{n.d(t,{Z:()=>s});var r=n(67294),i=n(86010);const a={tabItem:"tabItem_Ymn6"};function s(e){let{children:t,hidden:n,className:s}=e;return r.createElement("div",{role:"tabpanel",className:(0,i.Z)(a.tabItem,s),hidden:n},t)}},74866:(e,t,n)=>{n.d(t,{Z:()=>S});var r=n(87462),i=n(67294),a=n(86010),s=n(12466),o=n(16550),l=n(91980),u=n(67392),p=n(50012);function c(e){return function(e){var t,n;return null!=(t=null==(n=i.Children.map(e,(e=>{if(!e||(0,i.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error("Docusaurus error: Bad <Tabs> child <"+("string"==typeof e.type?e.type:e.type.name)+'>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.')})))?void 0:n.filter(Boolean))?t:[]}(e).map((e=>{let{props:{value:t,label:n,attributes:r,default:i}}=e;return{value:t,label:n,attributes:r,default:i}}))}function d(e){const{values:t,children:n}=e;return(0,i.useMemo)((()=>{const e=null!=t?t:c(n);return function(e){const t=(0,u.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error('Docusaurus error: Duplicate values "'+t.map((e=>e.value)).join(", ")+'" found in <Tabs>. Every value needs to be unique.')}(e),e}),[t,n])}function f(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function m(e){let{queryString:t=!1,groupId:n}=e;const r=(0,o.k6)(),a=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return null!=n?n:null}({queryString:t,groupId:n});return[(0,l._X)(a),(0,i.useCallback)((e=>{if(!a)return;const t=new URLSearchParams(r.location.search);t.set(a,e),r.replace({...r.location,search:t.toString()})}),[a,r])]}function h(e){const{defaultValue:t,queryString:n=!1,groupId:r}=e,a=d(e),[s,o]=(0,i.useState)((()=>function(e){var t;let{defaultValue:n,tabValues:r}=e;if(0===r.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(n){if(!f({value:n,tabValues:r}))throw new Error('Docusaurus error: The <Tabs> has a defaultValue "'+n+'" but none of its children has the corresponding value. Available values are: '+r.map((e=>e.value)).join(", ")+". If you intend to show no default tab, use defaultValue={null} instead.");return n}const i=null!=(t=r.find((e=>e.default)))?t:r[0];if(!i)throw new Error("Unexpected error: 0 tabValues");return i.value}({defaultValue:t,tabValues:a}))),[l,u]=m({queryString:n,groupId:r}),[c,h]=function(e){let{groupId:t}=e;const n=function(e){return e?"docusaurus.tab."+e:null}(t),[r,a]=(0,p.Nk)(n);return[r,(0,i.useCallback)((e=>{n&&a.set(e)}),[n,a])]}({groupId:r}),b=(()=>{const e=null!=l?l:c;return f({value:e,tabValues:a})?e:null})();(0,i.useLayoutEffect)((()=>{b&&o(b)}),[b]);return{selectedValue:s,selectValue:(0,i.useCallback)((e=>{if(!f({value:e,tabValues:a}))throw new Error("Can't select invalid tab value="+e);o(e),u(e),h(e)}),[u,h,a]),tabValues:a}}var b=n(72389);const g={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};function y(e){let{className:t,block:n,selectedValue:o,selectValue:l,tabValues:u}=e;const p=[],{blockElementScrollPositionUntilNextRender:c}=(0,s.o5)(),d=e=>{const t=e.currentTarget,n=p.indexOf(t),r=u[n].value;r!==o&&(c(t),l(r))},f=e=>{var t;let n=null;switch(e.key){case"Enter":d(e);break;case"ArrowRight":{var r;const t=p.indexOf(e.currentTarget)+1;n=null!=(r=p[t])?r:p[0];break}case"ArrowLeft":{var i;const t=p.indexOf(e.currentTarget)-1;n=null!=(i=p[t])?i:p[p.length-1];break}}null==(t=n)||t.focus()};return i.createElement("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.Z)("tabs",{"tabs--block":n},t)},u.map((e=>{let{value:t,label:n,attributes:s}=e;return i.createElement("li",(0,r.Z)({role:"tab",tabIndex:o===t?0:-1,"aria-selected":o===t,key:t,ref:e=>p.push(e),onKeyDown:f,onClick:d},s,{className:(0,a.Z)("tabs__item",g.tabItem,null==s?void 0:s.className,{"tabs__item--active":o===t})}),null!=n?n:t)})))}function k(e){let{lazy:t,children:n,selectedValue:r}=e;const a=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=a.find((e=>e.props.value===r));return e?(0,i.cloneElement)(e,{className:"margin-top--md"}):null}return i.createElement("div",{className:"margin-top--md"},a.map(((e,t)=>(0,i.cloneElement)(e,{key:t,hidden:e.props.value!==r}))))}function v(e){const t=h(e);return i.createElement("div",{className:(0,a.Z)("tabs-container",g.tabList)},i.createElement(y,(0,r.Z)({},e,t)),i.createElement(k,(0,r.Z)({},e,t)))}function S(e){const t=(0,b.Z)();return i.createElement(v,(0,r.Z)({key:String(t)},e))}},22354:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>m,frontMatter:()=>o,metadata:()=>u,toc:()=>c});var r=n(87462),i=(n(67294),n(3905)),a=n(74866),s=n(85162);const o={title:"Subscription Offers",sidebar_label:"Subscription Offers"},l=void 0,u={unversionedId:"inappbilling/subscription-offers",id:"inappbilling/subscription-offers",title:"Subscription Offers",description:"A subscription represents a set of benefits users can access during a specified time period. For example, a subscription might entitle a user to access a music streaming service.",source:"@site/docs/inappbilling/subscription-offers.mdx",sourceDirName:"inappbilling",slug:"/inappbilling/subscription-offers",permalink:"/docs/inappbilling/subscription-offers",draft:!1,tags:[],version:"current",frontMatter:{title:"Subscription Offers",sidebar_label:"Subscription Offers"},sidebar:"inappbilling",previous:{title:"Application Receipt",permalink:"/docs/inappbilling/application-receipt"},next:{title:"Introductory Prices",permalink:"/docs/inappbilling/introductory-prices"}},p={},c=[{value:"Retrieving Subscription Offers",id:"retrieving-subscription-offers",level:2},{value:"Phases",id:"phases",level:3},{value:"Installment plans",id:"installment-plans",level:3},{value:"Determine Eligibility",id:"determine-eligibility",level:2},{value:"Google Play Billing",id:"google-play-billing",level:3},{value:"Apple In-App Purchases",id:"apple-in-app-purchases",level:3},{value:"Introductory Offers",id:"introductory-offers",level:4},{value:"Promotional Offers",id:"promotional-offers",level:4},{value:"Display Offer",id:"display-offer",level:2},{value:"Make the Purchase",id:"make-the-purchase",level:2},{value:"Generate Signature",id:"generate-signature",level:2},{value:"NodeJS Example",id:"nodejs-example",level:3},{value:"Policy Guidelines",id:"policy-guidelines",level:2},{value:"Imports",id:"imports",level:2}],d={toc:c},f="wrapper";function m(e){let{components:t,...o}=e;return(0,i.kt)(f,(0,r.Z)({},d,o,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"A subscription represents a set of benefits users can access during a specified time period. For example, a subscription might entitle a user to access a music streaming service."),(0,i.kt)("p",null,'You can have multiple subscriptions within the same app, either to represent different sets of benefits, or different tiers of a single set of benefits ("Silver" and "Gold" tiers, for example).'),(0,i.kt)("p",null,"Through base plans and offers, you can create multiple configurations for the same subscription product. For example, you can create an introductory offer for users who have never subscribed to your app."),(0,i.kt)("h2",{id:"retrieving-subscription-offers"},"Retrieving Subscription Offers"),(0,i.kt)("p",null,"Information on the offers for a subscription are retrieved when you get your products."),(0,i.kt)("p",null,"Every subscription will have at least one available ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionOffer"),". These are retrieved for each ",(0,i.kt)("inlineCode",{parentName:"p"},"Product")," in the ",(0,i.kt)("inlineCode",{parentName:"p"},"subscriptionOffers")," property which is an array of ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionOffer")," objects."),(0,i.kt)(a.Z,{groupId:"framework",defaultValue:"air",values:[{label:"AIR",value:"air"},{label:"Unity",value:"unity"}],mdxType:"Tabs"},(0,i.kt)(s.Z,{value:"air",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-actionscript"},'InAppBilling.service.addEventListener( \n    ProductEvent.PRODUCTS_LOADED, \n    products_loadedHandler );\n                \nInAppBilling.service.getProducts( [ productId ] );\n\n\nfunction products_loadedHandler( event:ProductEvent ):void \n{\n    for each (var product:Product in event.products)\n    {\n        if (product.subscriptionOffers != null)\n        {\n            for each (var offer:SubscriptionOffer in product.subscriptionOffers)\n            {\n                trace( "OFFER: " + offer.id + "[" + offer.tags.join( "," ) + "]" )\n                for each (var phase:SubscriptionPhase in offer.pricingPhases)\n                {\n                    trace( "\\t PHASE: " + phase.priceString + " - " + phase.numberOfPeriods + "/" + phase.recurrenceMode\n                                    + " @ [" + phase.subscriptionPeriod.numberOfUnits + " " + phase.subscriptionPeriod.unit + "]" );\n\n                }\n            }\n        }\n    }\n}\n'))),(0,i.kt)(s.Z,{value:"unity",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},'InAppBilling.Instance.Events.OnGetProductsSuccess += ProductsLoadedHandler;\n\nInAppBilling.Instance.GetProducts( new List<string> { productId } );\n\n\nprivate void ProductsLoadedHandler(ProductsEvent e)\n{\n    foreach (var product in e.products)\n    {\n        if (product.subscriptionOffers != null)\n        {\n            foreach (var offer in product.subscriptionOffers)\n            {\n                Debug.Log( "OFFER: " + offer.id + "[" + string.Join( ",", offer.tags ) + "]" );\n                foreach (var phase in offer.pricingPhases)\n                {\n                    Debug.Log( "\\t PHASE: " + phase.priceString + " - " + phase.numberOfPeriods + "/" + phase.recurrenceMode\n                                    + " @ [" + phase.subscriptionPeriod.numberOfUnits + " " + phase.subscriptionPeriod.unit + "]" );\n                }\n            }\n        }\n    }\n}\n')))),(0,i.kt)("h3",{id:"phases"},"Phases"),(0,i.kt)("p",null,"Each ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionOffer")," contains a series of ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionPhase"),"'s. Each phase describes a period of the subscription that has a specific price and period. "),(0,i.kt)("p",null,"For example, you may have a free trial phase followed by the normal subscription:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"phase 1 : price $0, period 1 week;"),(0,i.kt)("li",{parentName:"ul"},"phase 2 : price $X, period 1 month;")),(0,i.kt)("p",null,"Each offer will contain at least 1 phase. "),(0,i.kt)("h3",{id:"installment-plans"},"Installment plans"),(0,i.kt)("p",null,"An installment subscription is a type of subscription where users pay for the subscription in multiple installments over a period of time, rather than paying the entire subscription fee upfront."),(0,i.kt)("p",null,"If the subscription offer has installment plans available, then the ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionOffer")," will contain a ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionInstallmentPlan")," object which describes the installment plan available for that offer.\nYou can use this information to display the installment plan details to the user."),(0,i.kt)(a.Z,{groupId:"framework",defaultValue:"air",values:[{label:"AIR",value:"air"},{label:"Unity",value:"unity"}],mdxType:"Tabs"},(0,i.kt)(s.Z,{value:"air",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-actionscript"},'if (offer.installmentPlan != null)\n{\n    trace( "Installment Plan: commitmentPaymentsCount:" + offer.installmentPlan.commitmentPaymentsCount \n        + "  subsequentCommitmentPaymentsCount:" + offer.installmentPlan.subsequentCommitmentPaymentsCount \n    );\n}\n'))),(0,i.kt)(s.Z,{value:"unity",mdxType:"TabItem"})),(0,i.kt)("h2",{id:"determine-eligibility"},"Determine Eligibility"),(0,i.kt)("p",null,"Depending on the store, you may need to determine whether the current user is eligible for the discount. You can check this by inspecting the ",(0,i.kt)("inlineCode",{parentName:"p"},"storeDeterminedEligible")," flag on the ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionOffer")," instance."),(0,i.kt)("p",null,"This flag indicates whether the current user is determined to be eligible for the discount by the source store."),(0,i.kt)("p",null,"If this value is ",(0,i.kt)("inlineCode",{parentName:"p"},"true")," then you can assume the user is eligible for the discount. If it is ",(0,i.kt)("inlineCode",{parentName:"p"},"false")," then you will need to use the process defined by the current store to determine user eligibility."),(0,i.kt)("p",null,"For example, Google Play Billing only provides details on these offers to users who are eligible for the discount and so this value will be ",(0,i.kt)("inlineCode",{parentName:"p"},"true"),"."),(0,i.kt)("p",null,"As opposed to Apple In-App Purchases where you must determine eligibility by determining if the user has previously purchased a subscription."),(0,i.kt)("h3",{id:"google-play-billing"},"Google Play Billing"),(0,i.kt)("p",null,"The discount will only be available in the ",(0,i.kt)("inlineCode",{parentName:"p"},"subscriptionOffers")," array if the user is eligible for the offer. "),(0,i.kt)("h3",{id:"apple-in-app-purchases"},"Apple In-App Purchases"),(0,i.kt)("h4",{id:"introductory-offers"},"Introductory Offers"),(0,i.kt)("p",null,"Introductory offers will have the offer ",(0,i.kt)("inlineCode",{parentName:"p"},"id")," set to ",(0,i.kt)("inlineCode",{parentName:"p"},"introductoryOffer"),"."),(0,i.kt)("p",null,"To determine if a user is eligible for an introductory offer, check their receipt:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Validate the receipt as described in ",(0,i.kt)("a",{parentName:"li",href:"https://developer.apple.com/documentation/storekit/in-app_purchase/validating_receipts_with_the_app_store?language=objc"},"Validating Receipts with the App Store"),"."),(0,i.kt)("li",{parentName:"ul"},"Send the receipt to your server;"),(0,i.kt)("li",{parentName:"ul"},"Call the Apple verify receipt end point;"),(0,i.kt)("li",{parentName:"ul"},"Process the response;"),(0,i.kt)("li",{parentName:"ul"},"In the receipt, check the values of the is_trial_period and the is_in_intro_offer_period for all in-app purchase transactions. If either of these fields are true for a given subscription, the user is not eligible for an introductory offer on that subscription product or any other products within the same subscription group. ")),(0,i.kt)("p",null,"Based on the receipt, you will find that new and returning customers are eligible for introductory offers, including free trials:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"New subscribers are always eligible."),(0,i.kt)("li",{parentName:"ul"},"Lapsed subscribers who renew are eligible if they haven't previously used an introductory offer for the given product (or any product within the same subscription group).")),(0,i.kt)("h4",{id:"promotional-offers"},"Promotional Offers"),(0,i.kt)("p",null,"There are two aspects to determining a user's eligibility for an Apple promotional subscription offer:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"The App Store deems all customers with an existing or expired subscription in the app eligible to redeem a subscription offer. You can check whether the receipt contains any existing or expired subscription purchases to identify these current or lapsed subscribers.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"You determine any additional eligibility criteria for a specific subscription offer. Eligibility can be contingent on a wide range of business logic determined by your business needs."))),(0,i.kt)("admonition",{type:"note"},(0,i.kt)("p",{parentName:"admonition"},"Customers can redeem subscription offers only on devices running iOS 12.2 and later, macOS 10.14.4 and later, and tvOS 12.2 and later. Consider providing messaging prompting your customer to update their OS if they try to redeem a subscription offer in your app on a device running an older OS version.")),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://developer.apple.com/documentation/storekit/in-app_purchase/implementing_subscription_offers_in_your_app?language=objc"},"https://developer.apple.com/documentation/storekit/in-app_purchase/implementing_subscription_offers_in_your_app?language=objc"))),(0,i.kt)("p",null,"With Apple, some offers require the generation of a signature on your server. You can check this by checking the value of the ",(0,i.kt)("inlineCode",{parentName:"p"},"requiresSignature")," property on the ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionOffer"),". If this is ",(0,i.kt)("inlineCode",{parentName:"p"},"true")," then the offer represents an Apple promotional subscription offer and you need to generate a signature as per the following diagram:"),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(59212).Z,width:"1429",height:"768"})),(0,i.kt)("p",null,"See ",(0,i.kt)("a",{parentName:"p",href:"#generate-signature"},"Generate Signature")," for more information."),(0,i.kt)("h2",{id:"display-offer"},"Display Offer"),(0,i.kt)("p",null,"Once you determine the user is eligible for an introductory discount, query the extension for available products, and inspect the ",(0,i.kt)("inlineCode",{parentName:"p"},"subscriptionOffers")," property."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"You will have to display the alternate pricing based on whether you determined the user to be eligible.")," "),(0,i.kt)("p",null,"There may be more than one offer, so ensure that you display information on all of them. Eg, you may have a free trial period, followed by an introductory price discount, before the normal subscription price is applied. It is considered very important by the store policies that all this information is clearly displayed."),(0,i.kt)("h2",{id:"make-the-purchase"},"Make the Purchase"),(0,i.kt)("p",null,"To make a purchase of a subscription product you must provide details on the ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionOffer")," to purchase by adding a ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionOfferRequest")," to your ",(0,i.kt)("inlineCode",{parentName:"p"},"PurchaseRequest"),": "),(0,i.kt)(a.Z,{groupId:"framework",defaultValue:"air",values:[{label:"AIR",value:"air"},{label:"Unity",value:"unity"}],mdxType:"Tabs"},(0,i.kt)(s.Z,{value:"air",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-actionscript"},"var product:Product = ...;\nvar offer:SubscriptionOffer = ...;\n\nvar request:PurchaseRequest = new PurchaseRequest()\n        .setProductId( product.id )\n        .setApplicationUsername( applicationUsername )\n        .setSubscriptionOfferRequest(\n            new SubscriptionOfferRequest()\n                    .setSubscriptionOffer( offer )\n        );\n\nif (InAppBilling.service.checkPurchaseRequestValid( request ))\n{\n    InAppBilling.service.makePurchase( request );\n}\n"))),(0,i.kt)(s.Z,{value:"unity",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"Product product = ...;\nSubscriptionOffer offer = ...;\n\nPurchaseRequest request = new PurchaseRequest()\n        .SetProductId( product.id )\n        .SetApplicationUsername( applicationUsername )\n        .SetSubscriptionOfferRequest(\n            new SubscriptionOfferRequest()\n                    .SetSubscriptionOffer( offer )\n        );\n\nInAppBilling.Instance.MakePurchase( request );\n")))),(0,i.kt)("p",null,"The flow of the purchase will then proceed as a normal purchase."),(0,i.kt)("table",null,(0,i.kt)("thead",{parentName:"table"},(0,i.kt)("tr",{parentName:"thead"},(0,i.kt)("th",{parentName:"tr",align:null}),(0,i.kt)("th",{parentName:"tr",align:null}),(0,i.kt)("th",{parentName:"tr",align:null}))),(0,i.kt)("tbody",{parentName:"table"},(0,i.kt)("tr",{parentName:"tbody"},(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("img",{src:n(34678).Z,width:"300",height:"534"})),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("img",{src:n(84016).Z,width:"300",height:"534"})),(0,i.kt)("td",{parentName:"tr",align:null},(0,i.kt)("img",{src:n(39423).Z,width:"300",height:"534"}))))),(0,i.kt)("h2",{id:"generate-signature"},"Generate Signature"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("a",{parentName:"li",href:"https://developer.apple.com/documentation/storekit/in-app_purchase/generating_a_signature_for_subscription_offers"},"Reference"))),(0,i.kt)("p",null,"Once you have decided a user is eligible for the subscription offer, you can check if the offer requires a signature by looking at the ",(0,i.kt)("inlineCode",{parentName:"p"},"requiresSignature")," property on the ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionOffer"),". If this is ",(0,i.kt)("inlineCode",{parentName:"p"},"true")," then you must construct a signature for the ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionOfferRequest")," on your server."),(0,i.kt)("p",null,"The signature information required includes:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"keyIdentifier")," - the identifier of the subscription key used to sign the discount;"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"nonce")," - a throwaway value generated along with the signature;"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"signature")," - the actual signature;"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"timestamp")," - the timestamp when the signature was generated. ")),(0,i.kt)("p",null,"This information is then passed when purchasing the subscription by using the ",(0,i.kt)("inlineCode",{parentName:"p"},"setSignature()")," method on the ",(0,i.kt)("inlineCode",{parentName:"p"},"SubscriptionOfferRequest"),":"),(0,i.kt)(a.Z,{groupId:"framework",defaultValue:"air",values:[{label:"AIR",value:"air"},{label:"Unity",value:"unity"}],mdxType:"Tabs"},(0,i.kt)(s.Z,{value:"air",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-actionscript"},"var request:PurchaseRequest = new PurchaseRequest()\n        .setProductId( product.id )\n        .setApplicationUsername( applicationUsername )\n        .setSubscriptionOfferRequest(\n            new SubscriptionOfferRequest()\n                    .setSubscriptionOffer( offer )\n                    .setSignature( key, nonce, signature, timestamp )\n        );\n"))),(0,i.kt)(s.Z,{value:"unity",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"PurchaseRequest request = new PurchaseRequest()\n        .SetProductId( product.id )\n        .SetApplicationUsername( applicationUsername )\n        .SetSubscriptionOfferRequest(\n            new SubscriptionOfferRequest()\n                    .SetSubscriptionOffer( offer )\n                    .SetSignature( key, nonce, signature, timestamp )\n        );\n")))),(0,i.kt)("p",null,"The subscription key is generated through Apple's ",(0,i.kt)("a",{parentName:"p",href:"https://appstoreconnect.apple.com/"},"AppStoreConnect"),', in the "Users and Access" section.'),(0,i.kt)("p",null,(0,i.kt)("img",{src:n(61795).Z,width:"800",height:"290"})),(0,i.kt)("p",null,"On your server you must generate the signature using the following parameters:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"appBundleID"),": The app bundle identifier."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"keyIdentifier")," : A string that identifies the private key you use to generate the signature. You can find this identifier in App Store Connect Users and Access > Keys, in the KEY ID column for the subscription key you generated."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"productIdentifier")," : The subscription product identifier, productIdentifier. The app can provide this value."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"offerIdentifier")," : The subscription discount identifier, identifier. The app can provide this value."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"applicationUsername")," : An optional string value that you define; may be an empty string. The app can provide this value and uses it in applicationUsername."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"nonce")," : A unique UUID value that your server defines. This value is cached for 24 hours. The string representation of the nonce used in the signature must be in lowercase."),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"timestamp")," : A timestamp your server generates in UNIX epoch time format, in milliseconds; the timestamp keeps the offer active for 24 hours.")),(0,i.kt)("p",null,"You use all of this information to create the signature as per the ",(0,i.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/storekit/in-app_purchase/generating_a_signature_for_subscription_offers"},"Apple documentation"),". See the example below for a simple NodeJS implementation."),(0,i.kt)("h3",{id:"nodejs-example"},"NodeJS Example"),(0,i.kt)("p",null,"The following is a basic NodeJS example accepting the required information in the get parameters and returning the signature information in the JSON output.\nYou will need to place the private key that you created and downloaded alongside this script in the ",(0,i.kt)("inlineCode",{parentName:"p"},"subscription_certificate.p8")," file."),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-js"},"const http = require('http');\nconst url = require('url');\nconst express = require('express');\nconst app = express();\nconst uuid4 = require('uuid4');\nconst fs = require('fs');\n\nconst EC = require(\"elliptic\").ec;\nconst ec = new EC(\"secp256k1\");\nconst crypto = require('crypto');\n\nconst port = 8080;\n\n\n\nfunction generateSignatureHandler(req, res) { \n\n    // https://developer.apple.com/documentation/storekit/in-app_purchase/generating_a_signature_for_subscription_offers\n    \n    // Params\n    const appBundleID = req.query.appBundleID\n    const keyIdentifier = req.query.keyIdentifier\n    const productIdentifier = req.query.productIdentifier\n    const offerIdentifier = req.query.offerIdentifier\n    const applicationUsername = req.query.applicationUsername\n\n    const nonce = uuid4()\n    const timestamp = Math.floor(new Date())\n\n    // Combine the parameters into a UTF-8 string with \n    // an invisible separator ('\\u2063') between them, \n    // in the order shown:\n    // appBundleId + '\\u2063' + keyIdentifier + '\\u2063' + productIdentifier + \n    // '\\u2063' + offerIdentifier + '\\u2063' + applicationUsername + '\\u2063' + \n    // nonce + '\\u2063' + timestamp\n\n    let payload = \n        appBundleID + '\\u2063' \n        + keyIdentifier + '\\u2063' \n        + productIdentifier + '\\u2063' \n        + offerIdentifier + '\\u2063' \n        + applicationUsername + '\\u2063'\n        + nonce+ '\\u2063' \n        + timestamp;\n\n    // Sign the combined string\n    // Private Key - p8 file downloaded\n    // Algorithm - ECDSA with SHA-256\n\n    const keyPem = fs.readFileSync('subscription_certificate.p8', 'ascii');\n\n    // Step 4\n    // Base64-encode the binary signature\n    const signature = crypto.createSign('RSA-SHA256')\n                    .update(payload)\n                    .sign(keyPem, 'base64');\n\n    let response1 = {\n        \"signature\": signature,\n        \"nonce\": nonce,\n        \"timestamp\": timestamp,\n        \"keyIdentifier\": keyIdentifier\n    }\n    res.type('json').send(response1);\n\n}\n\napp.get( '/', generateSignatureHandler );\napp.listen( port, () => console.log(`Listening on port ${port}!`) );\n\n\n// http://localhost:8080?appBundleID=ASDFASDF&keyIdentifier=JZCXH9P46S&productIdentifier=asdf&offerIdentifier=asdf&applicationUsername=asdf\n\n")),(0,i.kt)(a.Z,{groupId:"framework",defaultValue:"air",values:[{label:"AIR",value:"air"},{label:"Unity",value:"unity"}],mdxType:"Tabs"},(0,i.kt)(s.Z,{value:"air",mdxType:"TabItem"},(0,i.kt)("p",null,"This could be used in your AIR application as below, (however you will most likely need to implement a more robust solution for a production application):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-actionscript"},'var product:Product = ...;\nvar offer:SubscriptionOffer = ...;\n\ngenerateSignature(\n        product,\n        offer,\n        applicationUsername,\n        function(key:String, nonce:String, signature:String, timestamp:Number):void\n        {\n            var request:PurchaseRequest = new PurchaseRequest()\n                .setProductId( product.id )\n                .setApplicationUsername( applicationUsername )\n                .setSubscriptionOfferRequest(\n                        new SubscriptionOfferRequest()\n                                .setSubscriptionOffer( offer )\n                                .setSignature( key, nonce, signature, timestamp )\n                );\n            \n            if (InAppBilling.service.checkPurchaseRequestValid( request ))\n            {\n                InAppBilling.service.makePurchase( request );\n            }\n        }\n);\n        \nfunction generateSignature(\n    product:Product, \n    offer:SubscriptionOffer, \n    applicationUsername:String,\n    callback:Function ):void\n{\n    var vars:URLVariables    = new URLVariables();\n    vars.appBundleID         = "com.distriqt.test";\n    vars.keyIdentifier       = APPLE_KEY_IDENTIFIER;\n    vars.productIdentifier   = product.id;\n    vars.offerIdentifier     = offer.id;\n    vars.applicationUsername = applicationUsername;\n\n    var request:URLRequest = new URLRequest();\n    request.url            = APPLE_DISCOUNT_SIGNATURE_SERVER;\n    request.method         = URLRequestMethod.GET;\n    request.data           = vars;\n\n    var loader:URLLoader = new URLLoader();\n    loader.addEventListener( Event.COMPLETE, function ( event:Event ):void\n    {\n        event.currentTarget.removeEventListener( event.type, arguments.callee );\n\n        var data:Object = JSON.parse( loader.data );\n\n        var key:String       = data.keyIdentifier;\n        var nonce:String     = data.nonce;\n        var signature:String = data.signature;\n        var timestamp:Number = data.timestamp;\n\n        callback( key, nonce, signature, timestamp );\n    } );\n    loader.load( request );\n}\n'))),(0,i.kt)(s.Z,{value:"unity",mdxType:"TabItem"},(0,i.kt)("p",null,"This could be used in your Unity application as below, (however you will most likely need to implement a more robust solution for a production application):"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},'Product sub = ...;\nSubscriptionOffer offer = ...;\n\nStartCoroutine(\n    GenerateSignature(\n        sub,\n        offer,\n        "applicationUsername",\n        (keyIdentifier, nonce, signature, timestamp) =>\n        {\n            Log("Signature: " + keyIdentifier + " " + nonce + " " + signature + " " + timestamp);\n            PurchaseRequest request = new PurchaseRequest()\n                .SetProductId("com.distriqt.test.subscription1")\n                .SetSubscriptionOfferRequest(\n                    new SubscriptionOfferRequest()\n                        .SetSubscriptionOffer(offer)\n                        .SetSignature(keyIdentifier, nonce, signature, timestamp)\n                );\n\n            bool success = InAppBilling.Instance.MakePurchase(\n                request\n            );\n            Log("MakePurchase() = " + success);\n        }\n    )\n);\n\n[Serializable]\npublic class Signature\n{\n    public string keyIdentifier;\n    public string nonce;\n    public string signature;\n    public double timestamp;\n}\n\nprivate IEnumerator GenerateSignature(Product product, SubscriptionOffer offer, string applicationUsername, Action<string, string, string, double> onComplete)\n{\n    Dictionary<string, string> parameters = new Dictionary<string, string>\n    {\n        { "appBundleID", "com.distriqt.test" },\n        { "keyIdentifier", APPLE_KEY_IDENTIFIER },\n        { "productIdentifier", product.id },\n        { "offerIdentifier", offer.id },\n        { "applicationUsername", applicationUsername }\n    };\n\n    string queryString = "?";\n    foreach (KeyValuePair<string, string> param in parameters)\n    {\n        queryString += $"{UnityWebRequest.EscapeURL(param.Key)}={UnityWebRequest.EscapeURL(param.Value)}&";\n    }\n    queryString = queryString.TrimEnd(\'&\');\n\n    string url = APPLE_DISCOUNT_SIGNATURE_SERVER + queryString;\n    using (UnityWebRequest webRequest = UnityWebRequest.Get(url))\n    {\n        webRequest.SetRequestHeader("Content-Type", "application/json");\n        webRequest.SetRequestHeader("Authorization", "Bearer your_token_here");\n\n        yield return webRequest.SendWebRequest();\n\n        if (webRequest.result == UnityWebRequest.Result.ConnectionError ||\n            webRequest.result == UnityWebRequest.Result.ProtocolError)\n        {\n            Debug.LogError($"Error: {webRequest.error}");\n            yield break;\n        }\n        string jsonResponse = webRequest.downloadHandler.text;\n        try\n        {\n            Signature response = JsonUtility.FromJson<Signature>(jsonResponse);\n            onComplete?.Invoke(\n                            response.keyIdentifier,\n                            response.nonce,\n                            response.signature,\n                            response.timestamp\n                        );\n        }\n        catch (Exception e)\n        {\n            Debug.LogError($"Error parsing JSON: {e.Message}");\n        }\n    }\n}\n')))),(0,i.kt)("h2",{id:"policy-guidelines"},"Policy Guidelines"),(0,i.kt)("p",null,"There are some policy guidelines you will need to adhere to when displaying the subscription offers, mainly around the information that is displayed to the user when asking them to subscribe. Make sure you have read and followed the guidelines when implementing subscription offers:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Google Play Billing:\n",(0,i.kt)("a",{parentName:"p",href:"https://play.google.com/about/monetization-ads/subscriptions/#!?zippy_activeEl=management-cancellation#management-cancellation"},"https://play.google.com/about/monetization-ads/subscriptions/#!?zippy_activeEl=management-cancellation#management-cancellation"))),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},"Apple In-App Purchases:  ",(0,i.kt)("a",{parentName:"p",href:"https://developer.apple.com/design/human-interface-guidelines/in-app-purchase/overview/"},"https://developer.apple.com/design/human-interface-guidelines/in-app-purchase/overview/")))),(0,i.kt)("h2",{id:"imports"},"Imports"),(0,i.kt)(a.Z,{groupId:"framework",defaultValue:"air",values:[{label:"AIR",value:"air"},{label:"Unity",value:"unity"}],mdxType:"Tabs"},(0,i.kt)(s.Z,{value:"air",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-actionscript"},"import com.distriqt.extension.inappbilling.Product;\nimport com.distriqt.extension.inappbilling.PurchaseRequest;\nimport com.distriqt.extension.inappbilling.SubscriptionOffer;\nimport com.distriqt.extension.inappbilling.SubscriptionOfferRequest;\nimport com.distriqt.extension.inappbilling.SubscriptionPhase;\n\nimport com.distriqt.extension.inappbilling.event.ProductEvent;\n"))),(0,i.kt)(s.Z,{value:"unity",mdxType:"TabItem"},(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-csharp"},"using distriqt.plugins.inappbilling;\nusing distriqt.plugins.inappbilling.events;\n")))))}m.isMDXComponent=!0},59212:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/discounts-appstore-overview-1911923d10e366a3a40cff39ac40ad78.png"},61795:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/discounts-subscription-key-df7d81e6d11b9782cdc61c8055134421.png"},34678:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/ios_discount_subscription_freetrial_1-44fcb4485ef3263f5023c62de5795ad2.PNG"},84016:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/ios_discount_subscription_freetrial_2-53b09d5d791be6022c51efb03716eae1.PNG"},39423:(e,t,n)=>{n.d(t,{Z:()=>r});const r=n.p+"assets/images/ios_discount_subscription_freetrial_3-60ce54755359428823eb2b53cd4a579b.PNG"}}]);