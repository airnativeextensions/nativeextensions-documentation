(window.webpackJsonp=window.webpackJsonp||[]).push([[634],{689:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return s})),n.d(t,"rightToc",(function(){return c})),n.d(t,"default",(function(){return u}));var r=n(2),a=n(6),i=(n(0),n(821)),o={title:"Setup Auth Server",sidebar_label:"Setup Auth Server"},s={unversionedId:"applesignin/setup-auth-server",id:"applesignin/setup-auth-server",isDocsHomePage:!1,title:"Setup Auth Server",description:"Setup Auth Server",source:"@site/docs/applesignin/setup-auth-server.md",slug:"/applesignin/setup-auth-server",permalink:"/docs/applesignin/setup-auth-server",version:"current",sidebar_label:"Setup Auth Server"},c=[{value:"Setup Auth Server",id:"setup-auth-server",children:[]}],p={rightToc:c};function u(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(i.b)("wrapper",Object(r.a)({},p,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("h2",{id:"setup-auth-server"},"Setup Auth Server"),Object(i.b)("p",null,"When implementing Sign in with Apple on Android devices you need to setup a server that will receive the authorisation code and return data to the application.\nThis server application catches the user data posted by Apple and passes it to the extension. The extension will then use this information to further gather the identity token and user identifier."),Object(i.b)("p",null,"The below is an NodeJS example (taken from ",Object(i.b)("a",Object(r.a)({parentName:"p"},{href:"https://github.com/johncodeos-blog/SignInWithAppleBackendServer"}),"https://github.com/johncodeos-blog/SignInWithAppleBackendServer"),") which works with our implementation of Sign In with Apple on Android."),Object(i.b)("p",null,"This needs to be installed the server redirect url that you verified earlier and you should change the ",Object(i.b)("inlineCode",{parentName:"p"},"/appleoauth")," endpoint to match your needs. "),Object(i.b)("p",null,"To correctly setup the application you will need to enter all the information you gathered earlier into the ",Object(i.b)("inlineCode",{parentName:"p"},".env")," configuration file, including the filename of the key (",Object(i.b)("inlineCode",{parentName:"p"},"p8")," file) that you created. You must upload this file to the server alongside this code making sure it's not publicly accessible."),Object(i.b)("p",null,"If you wish to create your own version, you can use the logic in the below code."),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},"app.js")),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{className:"language-js"}),"require('dotenv').config();\n\nconst express = require('express');\nconst app = express();\nconst fs = require('fs');\nconst bodyParser = require('body-parser');\nconst jwt = require('jsonwebtoken');\n\nconst getClientSecret = () => {\n        const time = new Date().getTime() / 1000; // Current time in seconds since Epoch\n        const privateKey = fs.readFileSync(process.env.PRIVATE_KEY_FILE);\n        const headers = {\n                kid: process.env.KEY_ID,\n                typ: undefined\n        }\n        const claims = {\n                'iss': process.env.TEAM_ID,\n                'iat': time, // The time the token was generated\n                'exp': time + 86400 * 180, // Token expiration date\n                'aud': 'https://appleid.apple.com',\n                'sub': process.env.SERVICE_ID,\n        }\n        token = jwt.sign(claims, privateKey, {\n                algorithm: 'ES256',\n                header: headers\n        });\n        return token\n}\n\napp.post('/appleoauth', bodyParser.urlencoded({ extended: true }), (req, res) => {\n        if (res.statusCode == 200) {\n                var returnURL = \"\";\n                var firstName = \"\";\n                var middleName = \"\";\n                var lastName = \"\";\n                var email = \"\";\n                if (req.body.hasOwnProperty('user')) {\n                        const userdata = req.body.user;\n                        const user = JSON.parse(userdata);\n                        firstName = '&first_name=' + user.name['firstName'];\n                        middleName = '&middle_name=' + user.name['middleName'];\n                        lastName = '&last_name=' + user.name['lastName'];\n                        email = '&email=' + user.email;\n                }\n                var code = '&code=' + req.body.code;\n                var clientSecret = '&client_secret=' + getClientSecret();\n                returnURL = '?success=true' + code + clientSecret + firstName + middleName + lastName + email;\n                res.redirect(returnURL);\n        } else {\n                res.redirect('?success=false');\n        }\n})\n\nvar port = process.env.PORT;\napp.listen(port, () => console.log(`Your app is listening on port ` + port + '.'))\n")),Object(i.b)("p",null,Object(i.b)("inlineCode",{parentName:"p"},".env")),Object(i.b)("pre",null,Object(i.b)("code",Object(r.a)({parentName:"pre"},{}),"# Private Key .p8 file name\nPRIVATE_KEY_FILE=YOUR_KEY_NAME.p8\n\n# Key ID (Certificates, Identifiers & Profiles > Keys > Choose your app > Key ID)\nKEY_ID=YYYYYYYYYY\n\n# Team ID (Membership > Team ID)\nTEAM_ID=XXXXXXXXXX\n\n# Service ID (Certificates, Identifiers & Profiles > Identifiers > Change to Service IDs on the top right corner -> Choose your app -> Identifier)\nSERVICE_ID=YOUR.SERVICE.IDENTIFIER\n\n# The port to run the app\nPORT=3000\n")))}u.isMDXComponent=!0},821:function(e,t,n){"use strict";n.d(t,"a",(function(){return l})),n.d(t,"b",(function(){return h}));var r=n(0),a=n.n(r);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var p=a.a.createContext({}),u=function(e){var t=a.a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},l=function(e){var t=u(e.components);return a.a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},m=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,p=c(e,["components","mdxType","originalType","parentName"]),l=u(n),m=r,h=l["".concat(o,".").concat(m)]||l[m]||d[m]||i;return n?a.a.createElement(h,s(s({ref:t},p),{},{components:n})):a.a.createElement(h,s({ref:t},p))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=m;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var p=2;p<i;p++)o[p]=n[p];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,n)}m.displayName="MDXCreateElement"}}]);