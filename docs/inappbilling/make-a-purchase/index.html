<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.5">
<link rel="alternate" type="application/rss+xml" href="/news/rss.xml" title="air native extensions Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/news/atom.xml" title="air native extensions Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-188619114-3","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="air native extensions" href="/opensearch.xml"><title data-react-helmet="true">Make a Purchase | air native extensions</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:image" content="https://docs.airnativeextensions.com/img/ane-icon-black.png"><meta data-react-helmet="true" name="twitter:image" content="https://docs.airnativeextensions.com/img/ane-icon-black.png"><meta data-react-helmet="true" property="og:url" content="https://docs.airnativeextensions.com/docs/inappbilling/make-a-purchase"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Make a Purchase | air native extensions"><meta data-react-helmet="true" name="description" content="Finally we reach the most important process in this extension, making a purchase."><meta data-react-helmet="true" property="og:description" content="Finally we reach the most important process in this extension, making a purchase."><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://docs.airnativeextensions.com/docs/inappbilling/make-a-purchase"><link data-react-helmet="true" rel="alternate" href="https://docs.airnativeextensions.com/docs/inappbilling/make-a-purchase" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://docs.airnativeextensions.com/docs/inappbilling/make-a-purchase" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.f49ec264.css">
<link rel="preload" href="/assets/js/runtime~main.78df3bef.js" as="script">
<link rel="preload" href="/assets/js/main.843e3a71.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1boX">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/ane-icon-black.png" alt="AIR Native Extensions" class="themedImage_3oOy themedImage--light_3ouy navbar__logo"><img src="/img/ane-icon-white.png" alt="AIR Native Extensions" class="themedImage_3oOy themedImage--dark_3zJb navbar__logo"><b class="navbar__title">AIR Native Extensions</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a class="navbar__item navbar__link" href="/news/">News</a></div><div class="navbar__items navbar__items--right"><div class="react-toggle toggle_2ySP react-toggle--disabled"><div class="react-toggle-track" role="button" tabindex="-1"><div class="react-toggle-track-check"><span class="toggle_2iFN"> </span></div><div class="react-toggle-track-x"><span class="toggle_2iFN"> </span></div><div class="react-toggle-thumb"></div></div><input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"></div><div class="searchBox_xXbB"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_3zOJ"><button class="clean-btn backToTopButton_DkI0" type="button"><svg viewBox="0 0 24 24" width="28"><path d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z" fill="currentColor"></path></svg></button><aside class="docSidebarContainer_G8MK"><div class="sidebar_1tWv"><nav class="menu thin-scrollbar menu_1Iah menuWithAnnouncementBar_3acx"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/">Home</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/inappbilling/">InAppBilling</a></li><li class="menu__list-item"><a class="menu__link" href="/docs/inappbilling/overview">Overview</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Billing Services</a></li><li class="menu__list-item"><a class="menu__link menu__link--sublist" href="#">Setup the Extension</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/inappbilling/add-the-extension">Add the Extension</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/inappbilling/billing-service">Billing Service</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Usage</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/inappbilling/products">Products</a></li><li class="menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/inappbilling/make-a-purchase">Make a Purchase</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/inappbilling/pending-purchases">Pending Purchases</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/inappbilling/restore-purchases">Restore Purchases</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/inappbilling/get-purchases">Get Purchases</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/inappbilling/consuming-purchases">Consuming Purchases</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/inappbilling/change-a-purchase">Change a Purchase</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/inappbilling/promotions">Promotions</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Subscription Discounts and Offers</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/inappbilling/testing">Testing</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">In-App Updates</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Help</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Advanced</a></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Other</a></li></ul></nav></div></aside><main class="docMainContainer_3Zec"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_2q91"><div class="docItemContainer_37q2"><article><div class="tocCollapsible_3moT tocMobile_2bxg"><button type="button" class="clean-btn tocCollapsibleButton_3OYu">On this page</button></div><div class="markdown"><header><h1>Make a Purchase</h1></header><p>Finally we reach the most important process in this extension, making a purchase. </p><p>Making a purchase requires making a request to initiate the purchase and then &quot;finishing the purchase&quot; to
finalise the purchase and remove it from any internal queues.</p><p>Firstly create a <code>PurchaseRequest</code> object and set the <code>productId</code> and <code>quantity</code> you wish to purchase.
Then pass this object to the <code>makePurchase</code> function.
This will initiate the purchase flow, most likely leaving your application and taking the user to the store interface.</p><p>As the state of the purchase transaction changes you will be notified through the <code>PurchaseEvent.PURCHASES_UPDATED</code> event.</p><blockquote><p>Note: We have deprecated all of the old <code>PurchaseEvent</code>&#x27;s such as <code>PURCHASE_SUCCESS</code> in favour
of a processing queue through the <code>PURCHASES_UPDATED</code> event.</p><p>If you use any of the old events they will still work in the near future however we
suggest you migrate to the <code>PURCHASES_UPDATED</code> event to better handle purchase transaction states.</p></blockquote><div class="codeBlockContainer_21wf"><div class="codeBlockContent_1izB actionscript"><pre tabindex="0" class="prism-code language-actionscript codeBlock_1uaJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_3_dS"><span class="token-line" style="color:#393A34"><span class="token plain">InAppBilling.service.addEventListener( PurchaseEvent.PURCHASES_UPDATED, purchases_updatedHandler );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">InAppBilling.service.addEventListener( PurchaseEvent.PURCHASE_FAILED, purchase_failedHandler );</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var request:PurchaseRequest = new PurchaseRequest();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">request.productId = productId;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">request.quantity = 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var success:Boolean = InAppBilling.service.makePurchase( request );</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3XUZ clean-btn">Copy</button></div></div><p>It is also important that you listen for the <code>PURCHASE_FAILED</code> event. This will be dispatched
in situations where the purchase could not be attempted due to various reasons. You should
refer to the error code and message in the event to determine if it can be resolved.</p><p>One of the most common situations that this will occur on is when the product is already owned
by the user on Android. This case you should check for the <code>ITEM_ALREADY_OWNED</code> error code and
then load the purchases to retrieve the purchase.</p><p>See the section on <a href="/docs/inappbilling/get-purchases">Get Purchases</a> for more information on this process of retrieving purchases.</p><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_1iPN" id="finishing-purchases"></a>Finishing Purchases<a class="hash-link" href="#finishing-purchases" title="Direct link to heading">#</a></h2><p>As a rule it is important that you call <code>finishPurchase()</code> when you have completed the purchase
and either handled the error or deployed the product to the user&#x27;s inventory.</p><p>If you don&#x27;t call <code>finishPurchase()</code> then the next time the user opens the application and
you call <code>setup()</code> you will get notified again of the purchase as the system believes it to
still be pending. In some circumstances, failing to finish a purchase may result in the purchase
being cancelled and the user refunded.</p><p>Once complete the extension will dispatch the <code>FINISH_SUCCESS</code> event or if an error occurred then the <code>FINISH_FAILED</code> event will be dispatched:</p><div class="codeBlockContainer_21wf"><div class="codeBlockContent_1izB actionscript"><pre tabindex="0" class="prism-code language-actionscript codeBlock_1uaJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_3_dS"><span class="token-line" style="color:#393A34"><span class="token plain">InAppBilling.service.addEventListener( InAppBillingEvent.FINISH_SUCCESS, successHandler );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">InAppBilling.service.addEventListener( InAppBillingEvent.FINISH_FAILED, failedHandler );</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function successHandler( event:InAppBillingEvent ):void</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    trace( &quot;finish purchase complete&quot; );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function failedHandler( event:InAppBillingEvent ):void</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    trace( &quot;finish failed: [&quot;+event.errorCode+&quot;]&quot; + event.message );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3XUZ clean-btn">Copy</button></div></div><blockquote><p>You must call <code>finishPurchase</code> and confirm by receiving the <code>FINISH_SUCCESS</code> event
before attempting any other operation such as consuming the purchase. </p><p>The purchase is still in a pending state and not considered delivered to the user until you do. </p></blockquote><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_1iPN" id="apple-in-app-purchases"></a>Apple In-App Purchases<a class="hash-link" href="#apple-in-app-purchases" title="Direct link to heading">#</a></h3><p>With Apple&#x27;s In-App Purchases <code>finishPurchase()</code> will remove the purchase from the transaction queue,
and inform Apple that you have delivered (and potentially verified) the purchase.</p><p>On iOS you most often use this process to verify the transaction with your server, to verify whether you should deliver the product before calling <code>finishPurchase()</code> and the purchase information is removed from the queue.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor anchor__h3 anchorWithStickyNavbar_1iPN" id="google-play-billing"></a>Google Play Billing<a class="hash-link" href="#google-play-billing" title="Direct link to heading">#</a></h3><p>With Google Play Billing the call to <code>finishPurchase()</code> performs the acknowledgement of the purchase.
Purchases that aren&#x27;t acknowledged will be returned by the <code>getPendingPurchases()</code> method and <strong>may be refunded if you do not acknowledge them</strong>.</p><blockquote><p>Google Play supports purchasing products from inside of your app (in-app) or outside of your app (out-of-app). In order for Google Play to ensure a consistent purchase experience regardless of where the user purchases your product, you must acknowledge all purchases received through the Google Play Billing Library as soon as possible after granting entitlement to the user. If you do not acknowledge a purchase within three days, the user automatically receives a refund, and Google Play revokes the purchase. </p></blockquote><p>Note: <em>Previously you may have attached a developer payload at this point. This is no longer supported and has been removed by Google in the Play Billing library v3.0.</em> Instead consider using an obfuscated <code>applicationUsername</code> on your purchase request which will now get returned with a <code>Purchase</code> through Google Play Billing.</p><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_1iPN" id="example"></a>Example<a class="hash-link" href="#example" title="Direct link to heading">#</a></h2><p>The simplest way to do this is to simply call this in the event handler, however you may wish to do this at a later time,
for example, if you wish to validate the purchase using the transaction receipt with your application server. </p><div class="codeBlockContainer_21wf"><div class="codeBlockContent_1izB actionscript"><pre tabindex="0" class="prism-code language-actionscript codeBlock_1uaJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_3_dS"><span class="token-line" style="color:#393A34"><span class="token plain">// The service must be setup and a list of products retrieved.</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">InAppBilling.service.addEventListener( PurchaseEvent.PURCHASES_UPDATED, purchases_updatedHandler );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">InAppBilling.service.addEventListener( PurchaseEvent.PURCHASE_FAILED, purchase_failedHandler );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">InAppBilling.service.addEventListener( InAppBillingEvent.FINISH_SUCCESS, finishPurchase_successHandler );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">InAppBilling.service.addEventListener( InAppBillingEvent.FINISH_FAILED, finishPurchase_failedHandler );</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var request:PurchaseRequest = new PurchaseRequest();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">request.productId = productId;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">request.quantity = 1;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">var success:Boolean = InAppBilling.service.makePurchase( request );</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">trace( &quot;makePurchase( &quot;+productId+&quot; ) = &quot; + success );</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//  PURCHASE HANDLER</span></span><span class="token-line" style="color:#393A34"><span class="token plain">//</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function purchases_updatedHandler( event:PurchaseEvent ):void</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for each (var purchase:Purchase in event.data)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (purchase.transactionState)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // These transactions are in progress, so don&#x27;t finish them unless you don&#x27;t want them to complete</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case Purchase.STATE_PURCHASING:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case Purchase.STATE_DEFERRED:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // The purchased state should finished after you have delivered the product if applicable</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case Purchase.STATE_PURCHASED:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                trace( &quot;purchase success&quot; );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // If you wish you can add the purchase to your inventory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // and finish the purchase here</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                addPurchaseToInventory( purchase );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                InAppBilling.service.finishPurchase( purchase );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // Alternatively hold onto this purchase so we can call</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // finish when you&#x27;ve delivered the product</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // You would do this if you are validating the purchase on a server or</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // other operation that is required to complete before the product is delivered</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                //_purchases.push( purchase );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // For all other states you should handle appropriately and call finish purchase </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case Purchase.STATE_FAILED:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case Purchase.STATE_REFUNDED:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case Purchase.STATE_RESTORED:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case Purchase.STATE_REMOVED:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case Purchase.STATE_CANCELLED:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case Purchase.STATE_NOTALLOWED:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                InAppBilling.service.finishPurchase( purchase );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function purchase_failedHandler( event:PurchaseEvent ):void</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // This transaction failed so you should notify your user and finish the purchase</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    log( &quot;purchase failed [&quot; + event.errorCode + &quot;] :: &quot;+ event.message );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (event.data &amp;&amp; event.data.length &gt; 0)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        InAppBilling.service.finishPurchase( event.data[0] );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Android may return this code if the item is already owned</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    //</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (event.errorCode == ErrorCodes.ITEM_ALREADY_OWNED)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // You should use getPurchases() to retrieve the users purchases</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // and then add them as missing from their current inventory</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        InAppBilling.service.getPurchases();</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function finishPurchase_successHandler( event:InAppBillingEvent ):void</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    trace( &quot;finish purchase complete&quot; );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">function finishPurchase_failedHandler( event:InAppBillingEvent ):void</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    trace( &quot;finish failed: [&quot;+event.errorCode+&quot;]&quot; + event.message );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3XUZ clean-btn">Copy</button></div></div><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_1iPN" id="handling-user-cancellations"></a>Handling User Cancellations<a class="hash-link" href="#handling-user-cancellations" title="Direct link to heading">#</a></h2><p>When a user cancels a purchase there are two avenues that you&#x27;ll need to handle, due to the different ways that Android and iOS handle these cases.</p><p>On iOS there will be a <code>Purchase</code> initiated immediately so when the user cancels the purchase you will receive a <code>PurchaseEvent.PURCHASES_UPDATED</code> and the purchases transaction state will be set to <code>Purchase.STATE_CANCELLED</code>.
You will need to handle this case in your purchases updated handler and finish the purchase to remove it from the pending purchases queue.</p><p>For example:</p><div class="codeBlockContainer_21wf"><div class="codeBlockContent_1izB actionscript"><pre tabindex="0" class="prism-code language-actionscript codeBlock_1uaJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_3_dS"><span class="token-line" style="color:#393A34"><span class="token plain">function purchases_updatedHandler( event:PurchaseEvent ):void</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for each (var purchase:Purchase in event.data)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (purchase.transactionState)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Other states ... </span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case Purchase.STATE_CANCELLED:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                // User Cancelled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                InAppBilling.service.finishPurchase( purchase );</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">} </span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3XUZ clean-btn">Copy</button></div></div><p>On Android the purchase is not initiated so there is no <code>Purchase</code> to return, hence you will not receive a purchases updated event but instead a <code>PurchaseEvent.PURCHASE_FAILED</code> event will be dispatched. The error code on the failed event will be set to <code>ErrorCodes.USER_CANCELLED</code> or <code>ErrorCodes.RESPONSE_CANCELLED</code> so you can use this code to process the user cancellation. As this purchase was not initiated it does not need to be finished and will not appear in the pending purchases queue.</p><p>For example:</p><div class="codeBlockContainer_21wf"><div class="codeBlockContent_1izB actionscript"><pre tabindex="0" class="prism-code language-actionscript codeBlock_1uaJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_3_dS"><span class="token-line" style="color:#393A34"><span class="token plain">function purchase_failedHandler( event:PurchaseEvent ):void</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    switch (event.errorCode)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        // Other error codes...</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case ErrorCodes.RESPONSE_CANCELLED:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        case ErrorCodes.USER_CANCELLED:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // User cancelled</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3XUZ clean-btn">Copy</button></div></div><p>You should ensure you handle both these cases in your application if you wish to handle user cancellations. </p><hr><h2><a aria-hidden="true" tabindex="-1" class="anchor anchor__h2 anchorWithStickyNavbar_1iPN" id="deferred-purchases"></a>Deferred Purchases<a class="hash-link" href="#deferred-purchases" title="Direct link to heading">#</a></h2><p>Of special note are deferred purchases. Deferred purchases are purchases that are in progress and require further user action external to your application, such as a parental approval or payment in cash at a physical store.</p><p>With Apple&#x27;s In-App Purhcases:</p><blockquote><p>The transaction is in the queue, but its final status is pending external action such as Ask to Buy. Update your UI to show the deferred state, and wait for another callback that indicates the final status.</p></blockquote><p>With Google Play Billing the deferred state is equivalent to the &quot;PENDING&quot; purchase state where additional action is required before granting entitlement.</p><blockquote><p>For example, a user might choose to purchase your in-app product at a physical store using cash. This means that the transaction is completed outside of your app. In this scenario, you should grant entitlement only after the user has completed the transaction.</p></blockquote><p>In order to correctly handle deferred purchases you should <strong>not finish the purchase</strong>, but leave it in the queue until the user completes the external action.</p><p>Once the user completes the action you will receive a purchases updated event and should process the purchase at that point.
It is important however if you display some &quot;purchase in progress&quot; UI during the making a purchase process that you close that once you receive this event. You may wish to display a message appropriate to your application indicating that they need to take action outside the app.</p><div class="codeBlockContainer_21wf"><div class="codeBlockContent_1izB actionscript"><pre tabindex="0" class="prism-code language-actionscript codeBlock_1uaJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_3_dS"><span class="token-line" style="color:#393A34"><span class="token plain">function purchases_updatedHandler( event:PurchaseEvent ):void</span></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    for each (var purchase:Purchase in event.data)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">    {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        switch (purchase.transactionState)</span></span><span class="token-line" style="color:#393A34"><span class="token plain">        {</span></span><span class="token-line" style="color:#393A34"><span class="token plain">            // Do nothing with the deferred purchase. Ensure you close any &quot;purchase in progress&quot; UI </span></span><span class="token-line" style="color:#393A34"><span class="token plain">            case Purchase.STATE_DEFERRED:</span></span><span class="token-line" style="color:#393A34"><span class="token plain">                break;</span></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block">
</span></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_3XUZ clean-btn">Copy</button></div></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/inappbilling/products"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">« Products</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/inappbilling/pending-purchases"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Pending Purchases »</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_2pwG thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#finishing-purchases" class="table-of-contents__link">Finishing Purchases</a><ul><li><a href="#apple-in-app-purchases" class="table-of-contents__link">Apple In-App Purchases</a></li><li><a href="#google-play-billing" class="table-of-contents__link">Google Play Billing</a></li></ul></li><li><a href="#example" class="table-of-contents__link">Example</a></li><li><a href="#handling-user-cancellations" class="table-of-contents__link">Handling User Cancellations</a></li><li><a href="#deferred-purchases" class="table-of-contents__link">Deferred Purchases</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/tutorials/">tutorials</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://twitter.com/distriqt" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_37dV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/Gamua/Adobe-Runtime-Support/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>AIR discussions<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_37dV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://forum.starling-framework.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>starling<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_37dV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/distriqt" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>stack overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_37dV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/news">news</a></li><li class="footer__item"><a href="https://airnativeextensions.com/privacy" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_37dV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://airnativeextensions.com/license" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>license<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_37dV"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><br><a href="https://airnativeextensions.com">airnativeextensions.com</a> copyright © 2021 <br><br><a href="https://distriqt.com"><img src="/img/logo.png" alt="distriqt"></a></div></div></div></footer></div>
<script src="/assets/js/runtime~main.78df3bef.js"></script>
<script src="/assets/js/main.843e3a71.js"></script>
</body>
</html>