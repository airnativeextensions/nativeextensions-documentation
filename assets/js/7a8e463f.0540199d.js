"use strict";(self.webpackChunknativeextensions_documentation=self.webpackChunknativeextensions_documentation||[]).push([[28581],{3905:function(e,n,t){t.d(n,{Zo:function(){return c},kt:function(){return m}});var i=t(67294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);n&&(i=i.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,i)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function s(e,n){if(null==e)return{};var t,i,r=function(e,n){if(null==e)return{};var t,i,r={},a=Object.keys(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(i=0;i<a.length;i++)t=a[i],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var u=i.createContext({}),p=function(e){var n=i.useContext(u),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},c=function(e){var n=p(e.components);return i.createElement(u.Provider,{value:n},e.children)},l={inlineCode:"code",wrapper:function(e){var n=e.children;return i.createElement(i.Fragment,{},n)}},d=i.forwardRef((function(e,n){var t=e.components,r=e.mdxType,a=e.originalType,u=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),d=p(t),m=r,f=d["".concat(u,".").concat(m)]||d[m]||l[m]||a;return t?i.createElement(f,o(o({ref:n},c),{},{components:t})):i.createElement(f,o({ref:n},c))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var a=t.length,o=new Array(a);o[0]=d;var s={};for(var u in n)hasOwnProperty.call(n,u)&&(s[u]=n[u]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var p=2;p<a;p++)o[p]=t[p];return i.createElement.apply(null,o)}return i.createElement.apply(null,t)}d.displayName="MDXCreateElement"},71122:function(e,n,t){t.r(n),t.d(n,{assets:function(){return c},contentTitle:function(){return u},default:function(){return m},frontMatter:function(){return s},metadata:function(){return p},toc:function(){return l}});var i=t(83117),r=t(80102),a=(t(67294),t(3905)),o=["components"],s={title:"Discounts",sidebar_label:"Discounts"},u=void 0,p={unversionedId:"inappbilling/discounts",id:"inappbilling/discounts",title:"Discounts",description:"Offer discounted pricing for auto-renewable subscription products to eligible subscribers.",source:"@site/docs/inappbilling/discounts.md",sourceDirName:"inappbilling",slug:"/inappbilling/discounts",permalink:"/docs/inappbilling/discounts",draft:!1,tags:[],version:"current",frontMatter:{title:"Discounts",sidebar_label:"Discounts"},sidebar:"inappbilling",previous:{title:"Promotions",permalink:"/docs/inappbilling/promotions"},next:{title:"Introductory Prices",permalink:"/docs/inappbilling/introductory-prices"}},c={},l=[{value:"Available Discounts",id:"available-discounts",level:2},{value:"Determine Eligibility",id:"determine-eligibility",level:2},{value:"Generate Signature",id:"generate-signature",level:2},{value:"Make the Purchase",id:"make-the-purchase",level:2},{value:"NodeJS Example",id:"nodejs-example",level:3}],d={toc:l};function m(e){var n=e.components,s=(0,r.Z)(e,o);return(0,a.kt)("wrapper",(0,i.Z)({},d,s,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("strong",{parentName:"p"},"Offer discounted pricing for auto-renewable subscription products to eligible subscribers.")),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Available with Apple In-App Purchases")),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://developer.apple.com/documentation/storekit/in-app_purchase/implementing_subscription_offers_in_your_app?language=objc"},"https://developer.apple.com/documentation/storekit/in-app_purchase/implementing_subscription_offers_in_your_app?language=objc"))),(0,a.kt)("p",null,"To present a subscription offer, first determine the subscriber\u2019s eligibility, get the product details from the App Store, and generate a signature on your server."),(0,a.kt)("p",null,(0,a.kt)("img",{src:t(59212).Z,width:"1429",height:"768"})),(0,a.kt)("h2",{id:"available-discounts"},"Available Discounts"),(0,a.kt)("p",null,"You retrieve the available discounts along with the product details. A ",(0,a.kt)("inlineCode",{parentName:"p"},"Product")," instance will contain a ",(0,a.kt)("inlineCode",{parentName:"p"},"discounts")," array of ",(0,a.kt)("inlineCode",{parentName:"p"},"ProductDiscount")," objects representing the discounts available for the product."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-actionscript"},"InAppBilling.service.addEventListener( \n    InAppBillingEvent.PRODUCTS_LOADED, \n    products_loadedHandler );\n                \nInAppBilling.service.getProducts( [ productId ] );\n\n\nfunction products_loadedHandler( event:InAppBillingEvent ):void \n{\n    for each (var product:Product in event.data)\n    {\n        if (product.discounts != null)\n        {\n            for each (var discount:ProductDiscount in product.discounts)\n            {\n                // \n            }\n        }\n    }\n}\n")),(0,a.kt)("h2",{id:"determine-eligibility"},"Determine Eligibility"),(0,a.kt)("p",null,"You then need to determine whether the user is eligible for a discount and present the appropriate user interface to the user. "),(0,a.kt)("p",null,"There are two aspects to determining a user\u2019s eligibility for a subscription offers:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"The App Store deems all customers with an existing or expired subscription in the app eligible to redeem a subscription offer. You can check whether the receipt contains any existing or expired subscription purchases to identify these current or lapsed subscribers.")),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("p",{parentName:"li"},"You determine any additional eligibility criteria for a specific subscription offer. Eligibility can be contingent on a wide range of business logic determined by your business needs."))),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"Note: "),(0,a.kt)("p",{parentName:"blockquote"},"Customers can redeem subscription offers only on devices running iOS 12.2 and later, macOS 10.14.4 and later, and tvOS 12.2 and later. Consider providing messaging prompting your customer to update their OS if they try to redeem a subscription offer in your app on a device running an older OS version.")),(0,a.kt)("h2",{id:"generate-signature"},"Generate Signature"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://developer.apple.com/documentation/storekit/in-app_purchase/generating_a_signature_for_subscription_offers"},"Reference"))),(0,a.kt)("p",null,"Once you have decided to apply a discount to the purchase for the user you must construct a ",(0,a.kt)("inlineCode",{parentName:"p"},"PurchaseDiscountRequest")," and add it to the ",(0,a.kt)("inlineCode",{parentName:"p"},"PurchaseRequest"),"."),(0,a.kt)("p",null,"A ",(0,a.kt)("inlineCode",{parentName:"p"},"PurchaseDiscountRequest")," object requires a ",(0,a.kt)("inlineCode",{parentName:"p"},"ProductDiscount")," and a signature that you must generate through a server."),(0,a.kt)("p",null,"The signature information required includes:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"keyIdentifier")," - the identifier of the subscription key used to sign the discount;"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"nonce")," - a throwaway value generated along with the signature;"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"signature")," - the actual signature;"),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"timestamp")," - the timestamp when the signature was generated. ")),(0,a.kt)("p",null,"The subscription key is generated through Apple's ",(0,a.kt)("a",{parentName:"p",href:"https://appstoreconnect.apple.com/"},"AppStoreConnect"),', in the "Users and Access" section.'),(0,a.kt)("p",null,(0,a.kt)("img",{src:t(61795).Z,width:"800",height:"290"})),(0,a.kt)("p",null,"On your server you must generate the signature using the following parameters:"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"appBundleID"),": The app bundle identifier."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"keyIdentifier")," : A string that identifies the private key you use to generate the signature. You can find this identifier in App Store Connect Users and Access > Keys, in the KEY ID column for the subscription key you generated."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"productIdentifier")," : The subscription product identifier, productIdentifier. The app can provide this value."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"offerIdentifier")," : The subscription discount identifier, identifier. The app can provide this value."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"applicationUsername")," : An optional string value that you define; may be an empty string. The app can provide this value and uses it in applicationUsername."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"nonce")," : A unique UUID value that your server defines. This value is cached for 24 hours. The string representation of the nonce used in the signature must be in lowercase."),(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("inlineCode",{parentName:"li"},"timestamp")," : A timestamp your server generates in UNIX epoch time format, in milliseconds; the timestamp keeps the offer active for 24 hours.")),(0,a.kt)("p",null,"You use all of this information to create the signature as per the ",(0,a.kt)("a",{parentName:"p",href:"https://developer.apple.com/documentation/storekit/in-app_purchase/generating_a_signature_for_subscription_offers"},"Apple documentation"),". See the example below for a simple NodeJS implementation."),(0,a.kt)("h2",{id:"make-the-purchase"},"Make the Purchase"),(0,a.kt)("p",null,"Once you have your signature for the purchase discount you can construct your ",(0,a.kt)("inlineCode",{parentName:"p"},"PurchaseDiscountRequest")," and initiate the purchase."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-actionscript"},"var product:Product = ...;\nvar discount:ProductDiscount = ...; \n\nvar request:PurchaseRequest = new PurchaseRequest()\n        .setProductId( product.id )\n        .setApplicationUsername( applicationUsername )\n        .setDiscountRequest(\n                new PurchaseDiscountRequest()\n                        .setProductDiscount( discount )\n                        .setSignature( key, nonce, signature, timestamp )\n        );\n\nif (InAppBilling.service.checkPurchaseRequestValid( request ))\n{\n    InAppBilling.service.makePurchase( request );\n}\n")),(0,a.kt)("p",null,"The flow of the purchase will then proceed as a normal purchase."),(0,a.kt)("p",null,(0,a.kt)("img",{src:t(34678).Z,width:"300",height:"534"})),(0,a.kt)("p",null,(0,a.kt)("img",{src:t(84016).Z,width:"300",height:"534"})),(0,a.kt)("p",null,(0,a.kt)("img",{src:t(39423).Z,width:"300",height:"534"})),(0,a.kt)("h3",{id:"nodejs-example"},"NodeJS Example"),(0,a.kt)("p",null,"The following is a basic NodeJS example accepting the required information in the get parameters and returning the signature information in the JSON output.\nYou will need to place the private key that you created and downloaded alongside this script in the ",(0,a.kt)("inlineCode",{parentName:"p"},"subscription_certificate.p8")," file."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-js"},"const http = require('http');\nconst url = require('url');\nconst express = require('express');\nconst app = express();\nconst uuid4 = require('uuid4');\nconst fs = require('fs');\n\nconst EC = require(\"elliptic\").ec;\nconst ec = new EC(\"secp256k1\");\nconst crypto = require('crypto');\n\nconst port = 8080;\n\n\n\nfunction generateSignatureHandler(req, res) { \n  \n    // https://developer.apple.com/documentation/storekit/in-app_purchase/generating_a_signature_for_subscription_offers\n    \n    // Params\n    const appBundleID = req.query.appBundleID\n    const keyIdentifier = req.query.keyIdentifier\n    const productIdentifier = req.query.productIdentifier\n    const offerIdentifier = req.query.offerIdentifier\n    const applicationUsername = req.query.applicationUsername\n\n    const nonce = uuid4()\n    const timestamp = Math.floor(new Date())\n\n    // Combine the parameters into a UTF-8 string with \n    // an invisible separator ('\\u2063') between them, \n    // in the order shown:\n    // appBundleId + '\\u2063' + keyIdentifier + '\\u2063' + productIdentifier + \n    // '\\u2063' + offerIdentifier + '\\u2063' + applicationUsername + '\\u2063' + \n    // nonce + '\\u2063' + timestamp\n\n    let payload = \n        appBundleID + '\\u2063' \n        + keyIdentifier + '\\u2063' \n        + productIdentifier + '\\u2063' \n        + offerIdentifier + '\\u2063' \n        + applicationUsername + '\\u2063'\n        + nonce+ '\\u2063' \n        + timestamp;\n\n    // Sign the combined string\n    // Private Key - p8 file downloaded\n    // Algorithm - ECDSA with SHA-256\n\n    const keyPem = fs.readFileSync('subscription_certificate.p8', 'ascii');\n\n    // Step 4\n    // Base64-encode the binary signature\n    const signature = crypto.createSign('RSA-SHA256')\n                    .update(payload)\n                    .sign(keyPem, 'base64');\n\n    let response1 = {\n        \"signature\": signature,\n        \"nonce\": nonce,\n        \"timestamp\": timestamp,\n        \"keyIdentifier\": keyIdentifier\n    }\n    res.type('json').send(response1);\n\n}\n\napp.get( '/', generateSignatureHandler );\napp.listen( port, () => console.log(`Listening on port ${port}!`) );\n\n\n// http://localhost:8080?appBundleID=ASDFASDF&keyIdentifier=JZCXH9P46S&productIdentifier=asdf&offerIdentifier=asdf&applicationUsername=asdf\n\n")),(0,a.kt)("p",null,"This could be used in your AIR application as below, (however you will most likely need to implement a more robust solution for a production application):"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-actionscript"},'purchaseWithDiscountGetSignature(\n        product,\n        discount,\n        applicationUsername,\n        function(key:String, nonce:String, signature:String, timestamp:Number):void\n        {\n            var request:PurchaseRequest = new PurchaseRequest()\n                    .setProductId( product.id )\n                    .setApplicationUsername(applicationUsername)\n                    .setDiscountRequest(\n                            new PurchaseDiscountRequest()\n                                    .setProductDiscount( discount )\n                                    .setSignature( key, nonce, signature, timestamp )\n                    );\n            \n            if (InAppBilling.service.checkPurchaseRequestValid( request ))\n            {\n                InAppBilling.service.makePurchase( request );\n            }\n        }\n);\n        \nfunction purchaseWithDiscountGetSignature( \n    product:Product, \n    discount:ProductDiscount,\n    applicationUsername:String, \n    callback:Function ):void\n{\n    var vars:URLVariables = new URLVariables();\n    vars.appBundleID = "com.distriqt.test";\n    vars.keyIdentifier = "AAAAAXXXXX";\n    vars.productIdentifier = product.id;\n    vars.offerIdentifier = discount.id;\n    vars.applicationUsername = applicationUsername;\n    \n    var request:URLRequest = new URLRequest();\n    request.url = "http://server_ip_addr:8080/";\n    request.method = URLRequestMethod.GET;\n    request.data = vars;\n    \n    var loader:URLLoader = new URLLoader();\n    loader.addEventListener( Event.COMPLETE, function(event:Event):void\n    {\n        event.currentTarget.removeEventListener( event.type, arguments.callee );\n        \n        var data:Object = JSON.parse( loader.data );\n        \n        var key:String = data.keyIdentifier;\n        var nonce:String = data.nonce;\n        var signature:String = data.signature;\n        var timestamp:Number = data.timestamp;\n        \n        callback( key, nonce, signature, timestamp );\n    });\n    loader.load( request );\n}\n')))}m.isMDXComponent=!0},59212:function(e,n,t){n.Z=t.p+"assets/images/discounts-appstore-overview-1911923d10e366a3a40cff39ac40ad78.png"},61795:function(e,n,t){n.Z=t.p+"assets/images/discounts-subscription-key-df7d81e6d11b9782cdc61c8055134421.png"},34678:function(e,n,t){n.Z=t.p+"assets/images/ios_discount_subscription_freetrial_1-44fcb4485ef3263f5023c62de5795ad2.PNG"},84016:function(e,n,t){n.Z=t.p+"assets/images/ios_discount_subscription_freetrial_2-53b09d5d791be6022c51efb03716eae1.PNG"},39423:function(e,n,t){n.Z=t.p+"assets/images/ios_discount_subscription_freetrial_3-60ce54755359428823eb2b53cd4a579b.PNG"}}]);